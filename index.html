<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BiBi Cafe Feedback Form</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        *{margin:0;padding:0;box-sizing:border-box}
        body{font-family:'Inter',sans-serif;font-weight:200;background:linear-gradient(135deg,#f5f7fa 0%,#c3cfe2 100%);min-height:100vh;padding:20px}
        .hero-section{background:url('./1.png') center/cover;background-position:50% 66%;background-color:#fff;height:160px;margin-bottom:40px;border-radius:12px;position:relative;overflow:hidden;max-width:600px;margin:0 auto 40px auto}
        .hero-section::before{content:'';position:absolute;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.3)}
        .logo-container{display:flex;flex-direction:column;align-items:flex-start;margin-bottom:30px;max-width:600px;margin:0 auto 30px auto;position:relative;top:-80px;padding:0 20px}
        .logo{width:80px;height:80px;background:#8B4513;border-radius:50%;display:flex;align-items:center;justify-content:center;color:#d4af37;font-weight:bold;font-size:24px;border:3px solid #fff;flex-shrink:0;margin-bottom:15px}
        .cafe-name{color:#333;font-size:36px;font-weight:600}
        .form-container{max-width:600px;margin:0 auto;background:white;padding:40px;border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,.1);position:relative;top:-70px}
        .form-group{margin-bottom:30px}
        label{display:block;margin-bottom:8px;font-weight:600;color:#333;font-size:16px}
        .required{color:#e74c3c}
        input[type=text],input[type=tel],input[type=date],textarea{width:100%;padding:12px 16px;border:2px solid #e1e8ed;border-radius:8px;font-size:16px;transition:border-color .3s ease;font-family:inherit}
        input[type=text]:focus,input[type=tel]:focus,input[type=date]:focus,textarea:focus{outline:none;border-color:#d4af37}
        .star-rating{display:flex;gap:5px;margin-bottom:15px}
        .star{font-size:32px;color:#ddd;cursor:pointer;transition:color .2s ease}
        .star:hover,.star.active{color:#ffd700}
        textarea{resize:vertical;min-height:120px}
        .submit-btn{background:#333;color:white;padding:12px 24px;border:none;border-radius:8px;font-size:16px;font-weight:500;cursor:pointer;transition:all .2s ease;display:flex;align-items:center;gap:8px;width:100%;justify-content:center}
        .submit-btn:hover{background:#555}
        .submit-btn:disabled{background:#ccc;cursor:not-allowed}
        .submit-btn.success{background:#28a745;transform:scale(1.02)}
        .error-message{color:#e74c3c;font-size:14px;margin-top:5px}
        .success-message{background:#d4edda;color:#155724;padding:15px;border-radius:8px;margin-bottom:20px;text-align:center;animation:slideIn .3s ease}
        .error-alert{background:#f8d7da;color:#721c24;padding:15px;border-radius:8px;margin-bottom:20px;text-align:center}
        .checkmark{display:inline-block;width:16px;height:16px;background:#28a745;border-radius:50%;position:relative;animation:pop .3s ease}
        .checkmark:after{content:'‚úì';position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);color:white;font-size:12px;font-weight:bold}
        @keyframes slideIn{from{opacity:0;transform:translateY(-20px)}to{opacity:1;transform:translateY(0)}}
        @keyframes pop{0%{transform:scale(0)}50%{transform:scale(1.2)}100%{transform:scale(1)}}
        @media(max-width:480px){
            .form-container{padding:15px;margin:0 5px;top:-60px}
            .hero-section{height:120px;margin:0 5px 40px 5px}
            .logo-container{top:-60px;padding:0 15px}
            .cafe-name{font-size:24px}
            .logo{width:60px;height:60px;font-size:18px}
            .star{font-size:28px}
            input[type=text],input[type=tel],input[type=date],textarea{padding:10px 12px;font-size:16px}
        }
        @media(min-width:481px)and (max-width:768px){
            .form-container{padding:25px;margin:0 15px;top:-65px}
            .hero-section{height:130px;margin:0 15px 40px 15px}
            .logo-container{top:-65px;padding:0 25px}
            .cafe-name{font-size:30px}
            .logo{width:70px;height:70px;font-size:22px}
        }
        @media(min-width:769px)and (max-width:1024px){
            .form-container{padding:35px;max-width:700px}
            .hero-section,.logo-container{max-width:700px}
        }
        @media(min-width:1025px){
            .form-container{padding:40px;max-width:600px}
            .hero-section,.logo-container{max-width:600px}
        }
    </style>
</head>
<body>
    <div class="hero-section"></div>

    <div class="logo-container">
        <div class="logo">
            <img src="./B.png" alt="-" style="width:100px;height:95px;border-radius:50%;">
        </div>
        <h1 class="cafe-name">BiBi Caf√©</h1>
    </div>

    <div class="form-container">
        <div id="successMessage" class="success-message" style="display:none;">
            Thank you for your feedback! We appreciate your time.
        </div>
        <div id="errorMessage" class="error-alert" style="display:none;">
            Something went wrong. Please try again later.
        </div>

        <form id="feedbackForm">
            <div class="form-group">
                <label for="name">Name <span class="required">*</span></label>
                <input type="text" id="name" name="name" placeholder="Enter your name" required>
                <div class="error-message" id="nameError"></div>
            </div>

            <div class="form-group">
                <label for="contact">Contact Number <span class="required">*</span></label>
                <input type="tel" id="contact" name="contact" placeholder="Enter 10-digit mobile number" required>
                <div class="error-message" id="contactError"></div>
            </div>

            <div class="form-group">
                <label for="dob">Date of Birth <span class="required">*</span></label>
                <input type="date" id="dob" name="dob" required>
                <div class="error-message" id="dobError"></div>
            </div>

            <div class="form-group">
                <label>How would you rate our food? üçΩÔ∏è <span class="required">*</span></label>
                <div class="star-rating" id="foodRating">
                    <span class="star" data-rating="1">‚òÖ</span>
                    <span class="star" data-rating="2">‚òÖ</span>
                    <span class="star" data-rating="3">‚òÖ</span>
                    <span class="star" data-rating="4">‚òÖ</span>
                    <span class="star" data-rating="5">‚òÖ</span>
                </div>
                <textarea id="foodFeedback" name="foodFeedback" placeholder="We appreciate any additional feedback you may have..."></textarea>
                <div class="error-message" id="foodRatingError"></div>
            </div>

            <div class="form-group">
                <label>How would you rate our service? üë®‚Äçüíº <span class="required">*</span></label>
                <div class="star-rating" id="serviceRating">
                    <span class="star" data-rating="1">‚òÖ</span>
                    <span class="star" data-rating="2">‚òÖ</span>
                    <span class="star" data-rating="3">‚òÖ</span>
                    <span class="star" data-rating="4">‚òÖ</span>
                    <span class="star" data-rating="5">‚òÖ</span>
                </div>
                <textarea id="serviceFeedback" name="serviceFeedback" placeholder="We appreciate any additional feedback you may have..."></textarea>
                <div class="error-message" id="serviceRatingError"></div>
            </div>

            <button type="submit" class="submit-btn" id="submitBtn">
                <span id="submitText">Submit ‚Üí</span>
            </button>
        </form>
    </div>

    <script>
        // ultra-light UUID v4
        function uuid() {
            return ([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g, c =>
                (c ^ crypto.getRandomValues(new Uint8Array(1))[0] & 15 >> c / 4).toString(16)
            );
        }

        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyD0xIst7ZsXCb4ICF5aHxZFQVXQylaxMp9dbfyzCk-hSedYQ8RlY8OuTeaJEic9tFf/exec';
        const USE_GOOGLE_FORMS = false;

        const elements = {
            form: document.getElementById('feedbackForm'),
            submitBtn: document.getElementById('submitBtn'),
            submitText: document.getElementById('submitText'),
            successMessage: document.getElementById('successMessage'),
            errorMessage: document.getElementById('errorMessage'),
            name: document.getElementById('name'),
            contact: document.getElementById('contact'),
            dob: document.getElementById('dob'),
            foodFeedback: document.getElementById('foodFeedback'),
            serviceFeedback: document.getElementById('serviceFeedback')
        };

        const today = new Date().toISOString().split('T')[0];
        elements.dob.max = today;
        elements.dob.min = '1900-01-01';

        let foodRating = 0;
        let serviceRating = 0;
        let isSubmitting = false;

        function setupStarRating(containerId) {
            const container = document.getElementById(containerId);
            const stars = container.querySelectorAll('.star');

            stars.forEach(star => {
                star.addEventListener('mouseover', function () {
                    const rating = parseInt(this.dataset.rating);
                    highlightStars(container, rating);
                });

                star.addEventListener('mouseout', function () {
                    const currentRating = containerId === 'foodRating' ? foodRating : serviceRating;
                    highlightStars(container, currentRating);
                });

                star.addEventListener('click', function () {
                    const rating = parseInt(this.dataset.rating);
                    if (containerId === 'foodRating') foodRating = rating;
                    else serviceRating = rating;
                    highlightStars(container, rating);
                });
            });
        }

        function highlightStars(container, rating) {
            const stars = container.querySelectorAll('.star');
            stars.forEach((star, index) => star.classList.toggle('active', index < rating));
        }

        setupStarRating('foodRating');
        setupStarRating('serviceRating');

        const validateName = name => name.trim().length >= 2 && /^[a-zA-Z\s]+$/.test(name.trim());
        const validateContact = contact => /^[6-9]\d{9}$/.test(contact.replace(/\D/g, ''));
        const validateDOB = dob => {
            const date = new Date(dob);
            return date <= new Date() && date >= new Date('1900-01-01');
        };

        function showError(id, message) { const el = document.getElementById(id); if (el) el.textContent = message; }
        function clearError(id) { const el = document.getElementById(id); if (el) el.textContent = ''; }

        function showSuccess() {
            elements.submitBtn.classList.add('success');
            elements.submitText.innerHTML = '<span class="checkmark"></span> Submitted!';
            elements.successMessage.style.display = 'block';
            elements.errorMessage.style.display = 'none';
            elements.form.style.display = 'none';
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function showMainError(message) {
            elements.errorMessage.style.display = 'block';
            elements.successMessage.style.display = 'none';
            elements.errorMessage.textContent = message;
        }

        function hideAlerts() {
            elements.successMessage.style.display = 'none';
            elements.errorMessage.style.display = 'none';
        }

        let nameTimeout, contactTimeout, dobTimeout;
        elements.name.addEventListener('input', () => { clearTimeout(nameTimeout); nameTimeout = setTimeout(() => { validateName(elements.name.value) ? clearError('nameError') : showError('nameError', 'Please enter a valid name'); }, 300); });
        elements.contact.addEventListener('input', () => { clearTimeout(contactTimeout); contactTimeout = setTimeout(() => { validateContact(elements.contact.value) ? clearError('contactError') : showError('contactError', 'Please enter a valid 10-digit Indian mobile number'); }, 300); });
        elements.dob.addEventListener('change', () => { clearTimeout(dobTimeout); dobTimeout = setTimeout(() => { validateDOB(elements.dob.value) ? clearError('dobError') : showError('dobError', 'Please enter a valid date'); }, 100); });

        elements.form.addEventListener('submit', function (e) {
            e.preventDefault();
            if (isSubmitting) return;
            isSubmitting = true;
            elements.submitBtn.disabled = true;
            elements.submitBtn.classList.add('loading');
            hideAlerts();

            const name = elements.name.value;
            const contact = elements.contact.value;
            const dob = elements.dob.value;

            let isValid = true;
            const errors = [];

            if (!validateName(name)) {
                errors.push(['nameError', 'Please enter a valid name']);
                isValid = false;
            }
            if (!validateContact(contact)) {
                errors.push(['contactError', 'Please enter a valid 10-digit Indian mobile number']);
                isValid = false;
            }
            if (!validateDOB(dob)) {
                errors.push(['dobError', 'Please enter a valid date']);
                isValid = false;
            }
            if (foodRating === 0) {
                errors.push(['foodRatingError', 'Please rate our food']);
                isValid = false;
            }
            if (serviceRating === 0) {
                errors.push(['serviceRatingError', 'Please rate our service']);
                isValid = false;
            }

            if (!isValid) {
                errors.forEach(([id, msg]) => showError(id, msg));
                isSubmitting = false;
                elements.submitBtn.disabled = false;
                elements.submitBtn.classList.remove('loading');
                return;
            }

            ['nameError', 'contactError', 'dobError', 'foodRatingError', 'serviceRatingError'].forEach(clearError);
            showSuccess();

            const formData = {
                name, contact, dob,
                foodRating,
                foodFeedback: elements.foodFeedback.value,
                serviceRating,
                serviceFeedback: elements.serviceFeedback.value,
                timestamp: new Date().toISOString(),
                requestId: uuid()
            };

            this.reset();
            foodRating = 0;
            serviceRating = 0;
            highlightStars(document.getElementById('foodRating'), 0);
            highlightStars(document.getElementById('serviceRating'), 0);
            submitInBackground(formData);
        });


        async function submitInBackground(formData) {
            const maxRetries = 3;
            let retryCount = 0;
            while (retryCount < maxRetries) {
                try {
                    const promises = [];
                    promises.push(submitToGoogleScript(formData));
                    await Promise.any(promises);
                    console.log('Feedback submitted successfully');
                    break;
                } catch (error) {
                    retryCount++;
                    console.warn(`Submission attempt ${retryCount} failed:`, error);
                    await new Promise(resolve => setTimeout(resolve, Math.pow(2, retryCount) * 1000));
                }
            }
            if (retryCount === maxRetries) {
                try {
                    const saved = JSON.parse(localStorage.getItem('pendingFeedback') || '[]');
                    saved.push(formData);
                    localStorage.setItem('pendingFeedback', JSON.stringify(saved));
                    console.log('Saved feedback locally.');
                } catch (e) { console.error('Could not save feedback locally:', e); }
            }
            isSubmitting = false;
            elements.submitBtn.disabled = false;
            elements.submitBtn.classList.remove('loading');
        }

        async function submitToGoogleScript(data) {
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 2000);
            try {
                await fetch(SCRIPT_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data),
                    signal: controller.signal,
                    mode: 'no-cors'
                });
                clearTimeout(timeoutId);
            } catch (e) {
                clearTimeout(timeoutId);
                throw e;
            }
        }

        window.addEventListener('online', async () => {
            try {
                const pending = JSON.parse(localStorage.getItem('pendingFeedback') || '[]');
                if (pending.length) {
                    for (const data of pending) await submitInBackground(data);
                    localStorage.removeItem('pendingFeedback');
                }
            } catch (e) { console.error('Error syncing local feedback:', e); }
        });
    </script>
</body>
</html>
